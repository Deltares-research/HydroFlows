"""Module/ Rule for building FIAT models."""

from pathlib import Path

import hydromt_fiat
import pandas as pd
from fiat_toolbox.infographics.infographics_factory import InforgraphicFactory
from fiat_toolbox.metrics_writer.fiat_write_metrics_file import MetricsFileWriter

from hydroflows.workflow.method import Method
from hydroflows.workflow.method_parameters import Parameters

__all__ = ["FIATVisualize"]

FIAT_DATA_PATH = Path(
    Path(hydromt_fiat.__file__).parent,
    "data",
).as_posix()


class Input(Parameters):
    """Input parameters.

    This class represents the input data
    required for the :py:class:`FIATVisualize` method.
    """

    fiat_cfg: Path
    """
    The file path to the output of the FIAT model.
    """

    infographic_template: Path
    """Path to the infographics template file."""

    infometrics_template: Path
    """Path to the infometrics template file."""

    event_name: Path
    """Path to the eventset cfg file."""


class Output(Parameters):
    """Output parameters.

    This class represents the output data
    generated by the :py:class:`FIATVisualize` method.
    """

    fiat_infometrics: Path
    """The file path to the FIAT infometrics output."""

    fiat_infographics: Path
    """The file path to the FIAT infographics output."""


class Params(Parameters):
    """Parameters for the :py:class:`FIATVisualize`.

    Instances of this class are used in the :py:class:`FIATVisualize`
    method to define the required settings.

    See Also
    --------
    :py:class:`hydromt_fiat.fiat.FiatModel`
        For more details on the FiatModel used in hydromt_fiat.
    """

    fiat_root: Path
    """The path to the root directory where the FIAT model will be created."""


class FIATVisualize(Method):
    """Rule for visualizing FIAT output."""

    name: str = "fiat_visualize"

    def __init__(
        self,
        fiat_root: Path,
        fiat_cfg: Path,
        infographic_template: Path,
        infometrics_template: Path,
        **params,
    ) -> None:
        """Create and validate a FIATVisualize instance.

        Parameters
        ----------
        fiat_root : Path
            The path to the root directory where the FIAT model will be created, by default "models/fiat".
        fiat_cfg: Path
            The file path to the output of the FIAT model.
        infographic_template: Path
            Path to the infographics template file.
        infometrics_template: Path
            Path to the infometrics template file.
        **params
            Additional parameters to pass to the FIATVisualize instance.
            See :py:class:`fiat_build Params <hydroflows.methods.fiat.fiat_visualize.Params>`.

        See Also
        --------
        :py:class:`fiat_visualize Input <~hydroflows.methods.fiat.fiat_visualize.Input>`,
        :py:class:`fiat_visualize Output <~hydroflows.methods.fiat.fiat_visualize.Output>`,
        :py:class:`fiat_visualize Params <~hydroflows.methods.fiat.fiat_visualize.Params>`,
        :py:class:`hydromt_fiat.fiat.FIATModel`
        """
        self.params: Params = Params(fiat_root=fiat_root, **params)
        self.input: Input = Input(
            fiat_cfg=fiat_cfg,
            infographic_template=infographic_template,
            infometrics_template=infometrics_template,
        )
        self.output: Output = Output(
            fiat_infometrics=self.params.fiat_root / "infometrics.txt",
            fiat_infographics=self.params.fiat_root / "infographics.html",
        )

    def run(self):
        """Run the FIATVisualize method."""
        # Write infographics
        fiat_config = self.input.fiat_cfg.load_toml()
        risk = fiat_config["hazard"]["risk"]
        if risk == True:
            mode = "risk"
        else:
            mode = "single_event"

        scenario_name = self.input.event_name.load_toml()["name"]
        # Get the infographic
        InforgraphicFactory.create_infographic_file_writer(
            infographic_mode=mode,
            scenario_name=scenario_name,
            metrics_full_path=self.output.metrics.joinpath(
                scenario_name
            ),  # Users/rautenba/repos/Database/charleston_test/output/scenarios/current_test_set_no_measures/Infometrics_current_test_set_no_measures.csv')
            config_base_path=self.input.infographics_template.parent,  #'C:\\Users\\rautenba\\repos\\Database\\charleston_test\\static\\templates\\Infographics'
            output_base_path=self.output.joinpath(
                self.input.event_name.load_toml()["name"]
            ),
        ).write_infographics_to_file()

        # Write the metrics to file
        metrics_writer = MetricsFileWriter(
            self.input.infometrics_template
        )  # floodadapt_db/templates/infometrics/infographic_metrics_config_risk.toml # distinguish b/w risk and single event

        metrics_writer.parse_metrics_to_file(
            df_results=pd.read_csv(
                self.input.fiat_cfg.parent / "exposure" / "exposure.csv"
            ),
            metrics_path=self.output.fiat_infometrics.joinpath(scenario_name),
            write_aggregate=None,
        )

        metrics_writer.parse_metrics_to_file(
            df_results=pd.read_csv(
                self.input.fiat_cfg.parent / "exposure" / "exposure.csv"
            ),
            metrics_path=self.output.fiat_infometrics.joinpath(
                self.input.event_name.load_toml()["name"]
            ),
            write_aggregate="all",
        )
